<!DOCTYPE html>
<meta charset="utf-8"/>
<title>Mockup viewer</title>
<link rel="license" href="https://github.com/L2jLiga/mockup-viewer/LICENSE"/>
<link rel="stylesheet" href="assets/inpage.css"/>

<form id="open-file" method="POST" action="/open" enctype="multipart/form-data">
  <input name="mockup" type="file" accept="application/vnd.adobe.sparkler.project+dcxucf"/>
  <button>Submit</button>
</form>

<div class="mockups-list"></div>
<div class="mockups-container">
  <div class="mockups-container__mockups"></div>
</div>

<script>
  (() => {
    const form = document.forms.item(0);

    form.addEventListener('submit', (event) => {
      event.preventDefault();
      event.stopPropagation();

      const mockupInput = form.elements.mockup;

      const mockup = mockupInput.files[0];

      if (!mockup) {
        console.error('No file selected!');

        return;
      }

      return uploadFile(mockup);
    });

    function uploadFile(file) {
      console.log(file);

      const xhr = new XMLHttpRequest();
      const formData = new FormData();
      formData.append('mockup', file);

      xhr.upload.onprogress = function (event) {
        console.log(event.loaded + ' / ' + event.total);
      };

      xhr.onload = xhr.onerror = function () {
        if (this.status === 200) {
          console.log('success');

          injectMockup(JSON.parse(xhr.responseText).mockups);
        } else {
          console.log('error ' + this.status);
        }
      };

      xhr.open('POST', '/open', true);
      xhr.send(formData);
    }

    function injectMockup(mockups) {
      document.querySelector('.mockups-list').innerHTML = '';
      document.querySelector('.mockups-container__mockups').innerHTML = '';

      if (typeof mockups === 'string') {
        document.querySelector('.mockups-container__mockups').innerHTML = mockups;
      } else {
        Object.keys(mockups).map((mockupId) => {
          const mockupValue = mockups[mockupId];

          document.querySelector('.mockups-list').innerHTML += `<a href="#${mockupId}">${mockupId}</a>`;
          document.querySelector('.mockup-container__mockups').innerHTML += mockupValue;
        })
      }
    }
  })();
</script>

<!-- script src="assets/inpage.js"></script>
